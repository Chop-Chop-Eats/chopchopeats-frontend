## 第一步：设计一个“权限引导页” (Pre-Permission Primer)
这是整个流程中最关键的一步，能将授权成功率提升50%以上。不要直接调用系统的权限请求，而是先展示一个你自己设计的、全屏的、友好的引导页面。

这个页面应该包含：

- 清晰的价值主张 (Value Proposition)：

  - 大标题：例如“开启定位，发现附近品质美食”或“请授权位置信息，以便我们为您服务”。
  - 精美配图：一张与美食、配送相关的温馨图片，降低用户的防备心理。
  - 具体好处（用图标+文字）：
    - 发现附近商家：准确展示您身边的餐厅和优惠。
    - 计算配送距离：为您预估精准的配送费和送达时间。
    - 规划最佳路线：帮助骑手更快地将美食送到您手中。
- 一个明确的行动按钮 (Call to Action)：
  - 一个巨大、醒目的按钮，文字是“好的，开启定位”或“允许访问位置”。
这个引导页的作用：

- 在用户看到冷冰冰、不可定制的系统弹窗前，用你自己的语言和设计来“预热”和说服用户。
- 用户点击“好的，开启定位”这个按钮，意味着他已经心理上同意了，此时再弹出系统对话框，他点击“允许”的概率会大大增加。
## 第二步：实现完整的授权逻辑流程
现在，我们将引导页和 geolocator 的功能结合起来，形成一个完整的启动流程。这个流程通常在一个“启动页” (Splash Screen) 或者应用加载的初始阶段完成。

逻辑流程图（非常重要）：
```bash
(App 启动)
     |
     v
[检查位置权限状态: Geolocator.checkPermission()]
     |
     +-----> [状态: granted (已授权)] -----> (流程结束，直接获取经纬度，请求首页接口，进入主页)
     |
     +-----> [状态: denied (被拒绝过，但非永久)] -----> (展示“权限引导页”)
     |                                                 |
     |                                                 v
     |                                             [用户点击“开启定位”按钮]
     |                                                 |
     |                                                 v
     |                                             [请求系统权限: Geolocator.requestPermission()]
     |                                                 |
     |                                                 +-----> [用户允许] -----> (流程结束，获取经纬度，请求首页接口，进入主页)
     |                                                 |
     |                                                 +-----> [用户拒绝] -----> (停留在当前页，显示提示“无法获取位置，请重试”)
     |
     +-----> [状态: deniedForever (永久拒绝)] -----> (展示“去设置页”)
     |                                                 |
     |                                                 v
     |                                             [显示提示：“您已永久关闭权限，请在系统设置中手动开启”]
     |                                                 |
     |                                                 v
     |                                             [提供“去设置”按钮，点击后跳转到App的系统设置页]
     |
     +-----> [状态: notDetermined (iOS首次)] -----> (同 denied 流程，展示“权限引导页”)
```
## 第三步：技术实现细节
- 创建状态化的启动页 
  - 在 initState 方法中，调用一个 _checkPermissionAndNavigate() 的异步函数来启动整个流程。
- 编写 _checkPermissionAndNavigate() 函数
  - 这个函数将完整实现上面流程图的逻辑。
  - 你需要使用 geolocator 的 checkPermission() 和 requestPermission()。
  - 对于“去设置”的按钮，可以使用另一个很棒的库 permission_handler，它提供了 openAppSettings() 方法，可以一键跳转到应用的系统设置界面，极大地方便了用户。
- 处理后端兜底行为
  - 理想情况：用户授权，你获取到经纬度 (lat, lon)，调用首页接口 GET /home?lat=xx&lon=yy。
  - 阻塞情况：在用户完成授权之前，你的App应该停留在引导页或提示页，不应该去请求首页接口。因为没有经纬度，接口无法返回有意义的数据。

> 与后端约定：如果万一（在极少数情况下）获取经纬度失败，是否可以传一个默认值（比如某城市的中心点），让App至少能展示一些内容而不是白屏。但对于外卖App，更好的做法是强制用户授权，因为展示一个不相关城市的数据几乎没有意义。